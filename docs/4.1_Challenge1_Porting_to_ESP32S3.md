# Challenge 1: Porting the project to ESP32-S3 Wifi SoC

## Wiring up the sensor and actuator

Now that we are familiar with the ESP32-S3 board, let's connect the soil moisture sensor and the water pump.

### Soil Moisture Sensor

The soil moisture sensor has three pins: VCC, GND, and AOUT.

-   Connect **VCC** to the **3.3V** pin on the ESP32-S3.
-   Connect **GND** to the **GND** pin on the ESP32-S3.
-   Connect **AOUT** (Analog Out) to a GPIO pin that can be used as an Analog-to-Digital Converter (ADC) input. For this project, we will use **GPIO 1**.

<img src = "C:\Users\kwleung383\Documents\Personal\EE3070\Internet_of_things\docs\images\esp32s3_moisture_sensor_wiring.jpg">

*Note: The image above is a simplified representation. Ensure your connections are secure, preferably on a breadboard.*

### Water Pump and LEDs

The water pump is controlled by a relay module. The relay helps us control a higher voltage device (like the pump, which may require 5V or more) using a low-voltage signal from the ESP32-S3 (3.3V).

The relay module has 3 pins for control **(S, +, -)** and 3 pins for the load **(NC, COM, NO)**.

<img src = "C:\Users\kwleung383\Documents\Personal\EE3070\Internet_of_things\docs\images\relay.png">

-   Connect the relay's **+** to **5V** on the ESP32-S3. This 5V is provided by the USB port when ESP32S3 is connected to the PC. 
-   Connect the relay's **-** to a **GND** pin on the ESP32-S3.
-   Connect the relay's **S** (Input) pin to a digital GPIO pin on the ESP32-S3. We will use **GPIO 38**.

**For the pump itself:**

- Connect the **NO** (Normally Open) terminal of the relay to the negative (black) wire of the water pump.

- Connect the **COM** (Common) terminal of the relay to the negative terminal of the external power supply (e.g. GND on ESP32S3).

- Connect the positive (red) wire of the water pump to an external power supply (e.g., 5V on ESP32S3). **Note that if you are using the 5V from the USB port of your computer, the total current drawn by your project should not exceed 500mA.**

**For the LEDs:**

- Connect the Blue LED's anode to GPIO42 on ESP32-S3 and the LED's cathode connected to ground through a current limiting resistor of 51~120 Ohm.

- Connect the Red LED's anode to GPIO41 on ESP32-S3 and the LED's cathode connected to ground through a current limiting resistor of 390~470 Ohm.

<img src = "C:\Users\kwleung383\Documents\Personal\EE3070\Internet_of_things\docs\images\esp32s3_water_pump_wiring.jpg">

> **CAUTION:** To prevent damage to your hardware, always double-check your wiring connections before connecting any external power source.

## Porting the software to ESP32S3

The full source code is found in the `Code/7_Run_WaterPump_with_Millis_ESP32/` folder.

With the hardware wired up, the next step is to adapt the Arduino code to run on the ESP32-S3. The core logic remains the same, but we need to account for differences in pin numbers, how the ESP32 handles WiFi connection and analog inputs.

### Key Code Modifications

1. **Update Pin Definitions:**
   The first and most obvious change is to update the pin numbers in your code to match the new wiring.

   -   The moisture sensor is now on `GPIO 1`.
   -   The water pump relay is on `GPIO 38`.
   -   Red LED is now on `GPIO 41`.
   -   Blue LED on `GPIO 42`. 

   Your pin definition section should look like this:

   ```cpp
   #define SENSOR_PIN        1     //ESP32-S3 GPIO 1 (ADC1_CH0) for the moisture sensor
   #define PUMP_RELAY_PIN    38    //ESP32-S3 GPIO 38 to control the water pump relay  
   #define LED_RED_PIN       41
   #define LED_BLUE_PIN      42
   ```

2. **Analog-to-Digital Converter (ADC) Resolution:**
   The Arduino Mega uses a 10-bit ADC, which gives analog readings from 0 to 1023. The ESP32-S3 has a more precise 12-bit ADC, resulting in a range from 0 to 4095.

   This means the values you get from `analogRead(sensorPin)` will be different. You will need to **re-calibrate your sensor** using the `1_Calibrate_Moisture_Sensor.ino` sketch to find the new "wet" and "dry" values for the ESP32-S3.

   Your `map()` function to convert the raw reading to a percentage will need to use these new calibrated values. For example:

   ```cpp
   // Example values - you MUST find your own by calibrating!
   const int DRY_VALUE = 4095; // Raw ADC value for 0% moisture (in air)
   const int WET_VALUE = 1300; // Raw ADC value for 100% moisture (in water)
   ```

3. **Wi-Fi and ThingSpeak Code:**
   The code for connecting to Wi-Fi and uploading data to ThingSpeak will need to use the ESP32's built-in Wi-Fi library (`WiFi.h`) instead of the ESP8266-specific libraries.

   The good news is that the `ThingSpeak.h` library works seamlessly with the ESP32. You will primarily need to adjust the Wi-Fi connection part of the code.

   Here is a snippet extracted from the source code to highlight the changes:

   ```cpp
   #include <WiFi.h>	//replacing #include "ThingSpeak.h"
   #include "ThingSpeak.h"
   
   //...existing code
   WiFiClient thingspeakClient;	//replacing WiFiEspClient thingspeakClient
   
   void setup() {
     Serial.begin(115200);
     connectWiFi();			 	//replacing WiFi.init(&Serial1);
     ThingSpeak.begin(client);  	//Initialize ThingSpeak
     // ... rest of the setup
   }
   ```

   The `connectWifi()` function handles the connection logic, and the main loop will call this before attempting to update ThingSpeak. The rest of the ThingSpeak logic for setting fields and writing data remains the same.

### Key Improvements with ESP32-S3:

   * Simplified Codebase: The ESP32-S3 has a built-in Wi-Fi module, which eliminates the need for a separate ESP8266 and the complex serial communication between two microcontrollers. This results in cleaner and more straightforward code.

   * Simplified hardware connection because there is no ESP8266 required.

   * Redundant Variables Removed: Global variables like `isWifiModuleOK` are no longer necessary. The Wi-Fi status can be checked directly using the`WiFi.status()` function from the native WiFi library.

     
